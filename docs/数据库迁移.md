# 数据库迁移

项目使用 ent 管理表结构，迁移根据 `dal/model/ent/schema` 生成并执行 DDL。

## 首次建表

1. 确保 PostgreSQL 已安装并已创建库（如 `happyeat`），且 `app/etc/happyeatservice.yaml` 中 `SqlConfig.DataSource` 配置正确。
2. 在**项目根目录**执行：

```bash
make migrate
```

或进入 `app` 目录后执行：

```bash
cd app && go run ./cmd/migrate -f etc/happyeatservice.yaml
```

3. 执行成功后会在数据库中创建当前 schema 定义的所有表（如 `menus`、`menu_categories`、`menu_specs`、`tables`、`table_categories`、`orders`、`order_items` 等）。

## 升级（改 schema 后）

修改 `dal/model/ent/schema/*.go` 后：

1. 在 `dal/model/ent` 下执行 `go generate` 重新生成 ent 代码。
2. 再次执行 `make migrate`（或上述 `go run ./cmd/migrate`）。

ent 的 `Schema.Create` 会做增量迁移（存在表则跳过，新增表/列会创建）。若有破坏性变更（删列、改类型等），需自行备份或写迁移脚本。

## Casbin 策略表（casbin_rule）

权限模型使用 yaml 内联的 `casbin.model`，策略存储在数据库表 `casbin_rule` 中（由 pgx-adapter 使用同一 DataSource）。

- **建表**：adapter 首次连接时会自动创建 `casbin_rule`；也可手动执行 `dal/casbin/init_policy.sql` 建表并插入示例数据。
- **插入策略**：在表中按列 `ptype, v0, v1, v2, ...` 插入，或运行时通过 `ctx.Casbin.Enforcer.AddPolicy()` / `AddGroupingPolicy()` 等写入（会持久化到 DB）。

## 运行与功能验证

1. **前置**：PostgreSQL 已启动，已执行 `make migrate`；若需 Casbin 策略可执行 `dal/casbin/init_policy.sql`。
2. **启动服务**（项目根目录）：
   ```bash
   make run
   ```
   或：`cd app && go run . -f etc/happyeatservice.yaml`
3. 服务默认监听 **http://0.0.0.0:8888**，接口前缀 **/central/v1**（如 `GET /central/v1/menus`）。当前接口均启用了 JWT，需在 `app/etc/happyeatservice.yaml` 中增加 Auth 配置并请求时携带合法 Token，例如：
   ```yaml
   Auth:
     AccessSecret: "your-secret-key"
     AccessExpire: 86400
   ```
   再用 Postman、curl 或前端联调即可做功能验证。

## 注意

- 迁移命令会直接连接数据库并执行 DDL，生产环境请先在测试环境验证。
- `make migrate` 会先 `cd app` 再执行，配置文件使用 `etc/happyeatservice.yaml`（即 `app/etc/happyeatservice.yaml`）。
