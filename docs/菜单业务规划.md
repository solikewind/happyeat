# HappyEat 菜单业务规划

> 按「API 层 → 逻辑层 → 数据层 → 表设计」自上而下规划，遵循项目 MDC 约定。

---

## 一、API 层

### 1.1 现有接口（保持不变）

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /central/v1/menus | 列出菜单（分页、筛选） |
| GET | /central/v1/menu/:id | 获取单个菜单 |
| POST | /central/v1/menus | 创建菜单 |
| PUT | /central/v1/menu/:id | 更新菜单 |
| DELETE | /central/v1/menu/:id | 删除菜单 |
| GET | /central/v1/menu/categories | 列出菜单分类 |
| GET | /central/v1/menu/category/:id | 获取菜单分类 |
| POST | /central/v1/menu/category | 创建菜单分类 |
| PUT | /central/v1/menu/category/:id | 更新菜单分类 |
| DELETE | /central/v1/menu/category/:id | 删除菜单分类 |

### 1.2 类型调整（menutypes.api / menubase.api）

**Menu**（需调整）：

| 字段 | 类型 | 说明 |
|------|------|------|
| id | uint64 | 菜单 ID |
| name | string | 菜单名称 |
| description | string | 菜单描述 |
| image | string | 图片 URL（可选） |
| price | float64 | 基础价格 |
| category_id | uint64 | 分类 ID（关联 MenuCategory） |
| specs | []MenuSpec | 规格列表（新增，替换原 spec string） |
| create_at | int64 | 创建时间 |
| update_at | int64 | 更新时间（可选） |

**MenuSpec**（新增，在 menubase.api）：

| 字段 | 类型 | 说明 |
|------|------|------|
| spec_type | string | 规格类型（如 辣度、容量） |
| spec_value | string | 规格选项（如 微辣、大瓶） |
| price_delta | float64 | 加价（默认 0） |

**MenuCategory**：保持 id、name、description。

### 1.3 请求/响应约定

- **CreateMenuReq**：`{ "menu": { "name", "description", "image", "price", "category_id", "specs": [...] } }`
- **UpdateMenuReq**：同上，可含 id（或由路径 :id 提供）。
- **GetMenuReply / ListMenusReply**：Menu 含完整 specs 数组；category 可返回 category_id 或嵌套 category 对象（由逻辑层填充）。

---

## 二、逻辑层

### 2.1 菜单 CRUD

| Logic | 职责 |
|-------|------|
| CreateMenuLogic | 校验 name、price、category_id；写入 menu + menu_spec 批次 |
| UpdateMenuLogic | 校验 id 存在；更新 menu；删除旧 specs，插入新 specs（或按 id 增量更新） |
| DeleteMenuLogic | 软删或硬删 menu；同步删除关联 menu_spec |
| GetMenuLogic | 查 menu + specs，填充 category 信息 |
| ListMenusLogic | 分页、按 name/category_id 筛选；每条 menu 带 specs、category |

### 2.2 菜单分类 CRUD

保持现有逻辑；创建/更新菜单时校验 category_id 存在。

### 2.3 业务规则（示例）

1. name、category_id 必填；price >= 0。
2. specs 可为空；若有，spec_type、spec_value 非空；price_delta 可负（折扣）。
3. 删除分类前检查是否有菜单引用，有则禁止删除或先解绑。

---

## 三、数据层（ent）

数据层统一使用 **ent**（不混用 sqlx），便于关联查询与类型安全。

### 3.1 持久化需求

- **菜单**：id, name, description, image, price, category_id, created_at, updated_at。
- **菜单规格**：menu_id, spec_type, spec_value, price_delta, sort；一条记录 = 一个可选规格项。
- **菜单分类**：id, name, description, created_at, updated_at。

### 3.2 访问模式

- 按 menu_id 查 specs（GetMenu、ListMenus 时用 ent 的 Edges 或 Query）。
- 按 category_id 查 menus（ListMenus 筛选）。
- 创建/更新时：`ent.Tx` 内写 menu + menu_spec。

### 3.3 ent 放在 DAL（目录与接入约定）

ent 作为数据访问层放在 **dal** 下，与「model」同属一层，便于与 handler/logic 分离。

#### 目录结构

```
dal/model/
└── ent/
    ├── generate.go          # //go:generate go run entgo.io/ent/cmd/ent generate ./schema --target .
    ├── schema/              # ent schema 定义
    │   ├── menucategory.go
    │   ├── menu.go
    │   └── menuspec.go
    ├── client.go            # 生成
    ├── menu.go              # 生成
    ├── menucategory.go      # 生成
    ├── menuspec.go          # 生成
    └── ...
```

- **Schema 目录**：`dal/model/ent/schema/`；生成代码输出到 `dal/model/ent/`（与 schema 同级的 `client.go`、`menu.go` 等）。
- **Import**：Logic 层引用 `github.com/solikewind/happyeat/dal/model/ent`，使用 `ent.Client`、`ent.Menu` 等。

#### 配置与注入

- **配置**：在 `app/internal/config` 中增加 DB DSN；`app/internal/svc/ServiceContext` 中创建并持有 `*ent.Client`（如 `DB` 或 `Ent`），服务启动时 `ent.Open(driver)`，退出时 `client.Close()`。
- **Logic 使用**：`svcCtx.DB` 为 `*ent.Client`，在 Logic 内用 `svcCtx.DB.Menu.Create()...`、`svcCtx.DB.Menu.Query()...` 等。
- **迁移**：在 `dal/model/ent` 下执行 `go generate` 生成代码；使用 `ent migrate`（或自定义 migrate 脚本）根据 schema 落表。

---

## 四、表设计

### 4.1 menu 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | bigint PK | 主键 |
| name | varchar(128) | 菜单名称 |
| description | text | 描述 |
| image | varchar(512) | 图片 URL |
| price | decimal(10,2) | 基础价格 |
| category_id | bigint | 关联 menu_category.id |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

索引：category_id；name（可选，用于搜索）。

### 4.2 menu_spec 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | bigint PK | 主键 |
| menu_id | bigint | 关联 menu.id |
| spec_type | varchar(64) | 规格类型（辣度、容量等） |
| spec_value | varchar(64) | 规格选项（微辣、大瓶等） |
| price_delta | decimal(10,2) | 加价，默认 0 |
| sort | int | 同 menu 下排序，默认 0 |

索引：menu_id。

### 4.3 menu_category 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | bigint PK | 主键 |
| name | varchar(64) | 分类名称 |
| description | text | 描述 |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

---

## 五、实施顺序

1. **ent Schema + 生成**：在 `dal/model/ent/schema/` 定义 `Menu`、`MenuSpec`、`MenuCategory`（及 Edge）；在 `dal/model/ent` 下执行 `go generate` 生成代码；执行 `ent migrate` 落表。
2. **API 类型**：更新 `menubase.api`（Menu、MenuSpec）、`menutypes.api`；执行 goctl 生成。
3. **ServiceContext**：在 config 中加 DB DSN，在 `svc.NewServiceContext` 中创建 `*ent.Client`（来自 `dal/model/ent`）并注入，入口处 defer Close。
4. **Logic 实现**：用 `svcCtx.DB` 做 ent 的 Create/Query/Update/Delete；Handler 已由 goctl 生成，无需改。
5. **联调与测试**：接口测试、规格增删改查验证。

---

## 六、多租户与扩展（预留）

- 若后续需要多租户，在 `menu`、`menu_category` 加 `tenant_id`。
- 若后续需拆「规格类型 + 规格选项」，可新增 `spec_type`、`spec_option` 表，`menu_spec` 改为关联 option_id。
